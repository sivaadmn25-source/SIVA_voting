<!DOCTYPE html>
<html lang="{{ selected_language_code if selected_language_code else 'en' }}">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>{{ languages[selected_language_code]['voteTitle'] if selected_language_code and languages[selected_language_code].voteTitle else 'Welcome to Voting System' }}</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
      <style>
          /* Global Reset */
          *, *::before, *::after {
              box-sizing: border-box;
              margin: 0;
              padding: 0;
          }
  
          body {
              font-family: 'Inter', sans-serif;
              background-color: #f0f2f5;
              display: flex;
              flex-direction: column;
              justify-content: flex-start;
              align-items: center;
              min-height: 100vh;
              padding-top: 100px;
              color: #333;
              line-height: 1.4;
          }
  
          /* Ribbon Styles */
          .ribbon {
              width: 100%;
              max-width: 600px;
              height: 70px;
              background: linear-gradient(to bottom, #FF9933 33.33%, #FFFFFF 66.66%, #584df0 100%);
              position: fixed;
              top: 20px;
              left: 50%;
              transform: translateX(-50%);
              z-index: 1000;
              display: flex;
              justify-content: center;
              align-items: center;
              border-radius: 10px;
              box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
          }
          .ribbon h2 {
              color: #0000FF; /* Blue */
              font-size: 1.8rem;
              font-weight: 700;
              display: flex;
              align-items: center; /* Vertically centers them */
              justify-content: center; /* Centers the group */
              gap: 15px; /* Adds space between the Chakra and the text */ 
              text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
              margin: 0;
          }
        /* ðŸ”µ Authentic Spinning Ashoka Chakra 
        .chakra {
            width: 45px;
            height: 45px;
            animation: spinChakra 10s linear infinite;
        } 

        @keyframes spinChakra {
            from { transform: rotate(0deg); }
            to   { transform: rotate(360deg); }
        } */
        .ribbon .siva-text {
            font-weight: 800;
            font-size: 2.2rem;
            line-height: 1;
            background: linear-gradient(270deg, gold, orange, yellow, green, blue, indigo, violet, gold);
            background-size: 400% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow 5s linear infinite, flash 1s step-start infinite;
        }

        @keyframes rainbow {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
  
          /* Wrapper and Container Styles */
          .content-area-wrapper {
              width: 90%;
              max-width: 600px;
              margin: 0 auto;
              display: flex;
              flex-direction: column;
              align-items: center;
              flex-grow: 1;
              justify-content: flex-start;
          }
  
          .container {
              background-color: #ffffff;
              padding: 1rem;
              border-radius: 1rem;
              box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
              max-width: 400px;
              width: 90%;
              margin-top: 15px;
              margin-bottom: 15px;
              display: flex;
              flex-direction: column;
              gap: 0.5rem;
              position: relative;
          }
          .message-box {
              padding: 0.75rem;
              border-radius: 0.5rem;
              font-weight: 500;
              text-align: center;
              position: absolute;
              right: 10px;
              top: 150px;
              width: 150px;
              z-index: 10;
              box-shadow: 0 2px 8px rgba(0,0,0,0.15);
          }
          .message-success { background-color: #d1fae5; color: #065f46; }
          .message-error { background-color: #fee2e2; color: #991b1b; }
          .message-info { background-color: #e0f2fe; color: #0369a1; }
          .form-group { margin-bottom: 0.25rem; }
          label {
              display: block;
              margin-bottom: 0.25rem;
              font-weight: 500;
              color: #374151;
          }
          input[type="text"], input[type="password"], select {
              width: 100%;
              padding: 0.6rem;
              border: 1px solid #d1d5db;
              border-radius: 0.5rem;
              font-size: 0.95rem;
              color: #1f2937;
              background-color: #f9fafb;
              transition: border-color 0.2s;
          }
          input[type="text"]:focus, input[type="password"]:focus, select:focus {
              outline: none;
              border-color: #6366f1;
              box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
          }
          /* Button Styles */
          .btn-primary {
              background-image: linear-gradient(to right, #6366f1, #8b5cf6);
              color: white;
              padding: 0.4rem 1.2rem;
              border-radius: 0.75rem;
              font-weight: 600;
              transition: all 0.2s ease-in-out;
              box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
              border: none;
              cursor: pointer;
              width: auto;
              margin-left: auto;
              margin-right: auto;
              display: inline-block;
              text-align: center;
          }
          .btn-primary:hover {
              transform: translateY(-2px);
              box-shadow: 0 6px 15px rgba(99, 102, 241, 0.4);
              background-image: linear-gradient(to right, #4CAF50, #6BBF46);
          }
          .btn-secondary {
              background-color: #6b7280;
              color: #ffffff;
              padding: 0.4rem 1.2rem;
              border-radius: 0.75rem;
              font-weight: 600;
              transition: all 0.2s ease-in-out;
              border: none;
              cursor: pointer;
              width: auto;
              margin-left: auto;
              margin-right: auto;
              display: inline-block;
              text-align: center;
          }
          .btn-secondary:hover {
              transform: translateY(-2px);
              background-color: #4b5563;
          }
          .btn-green {
              background-color: #22c55e;
              color: #ffffff;
              padding: 0.4rem 1.2rem;
              border-radius: 0.75rem;
              font-weight: 600;
              transition: all 0.2s ease-in-out;
              box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3);
              border: none;
              cursor: pointer;
              width: auto;
              margin-left: auto;
              margin-right: auto;
              display: inline-block;
              text-align: center;
          }
          .btn-green:hover {
              transform: translateY(-2px);
              box-shadow: 0 6px 15px rgba(34, 197, 94, 0.4);
              background-color: #16a34a;
          }
          .btn:disabled {
              opacity: 0.6;
              cursor: not-allowed;
              box-shadow: none;
              transform: none;
          }
  
          .radio-group {
              display: flex;
              flex-direction: column;
              gap: 0.25rem;
          }
          .radio-option {
              display: flex;
              align-items: center;
              background-color: #f9fafb;
              padding: 0.6rem;
              border-radius: 0.5rem;
              border: 1px solid #e5e7eb;
              cursor: pointer;
              transition: all 0.2s ease-in-out;
          }
          .radio-option:hover {
              background-color: #eff6ff;
              border-color: #93c5fd;
          }
          .radio-option input[type="radio"] {
              margin-right: 0.5rem;
              transform: scale(1.1);
          }
          .hidden-fields {
            display: none !important;
            visibility: hidden;
          }   
          .back-container {
              display: flex;
              justify-content: center;
              margin-top: 0.1rem;
              width: 100%;
          }
          .global-overlay-message {
              position: fixed;
              bottom: 20px;
              right: 20px;
              background-color: rgba(0, 0, 0, 0.6);
              color: white;
              padding: 8px 12px;
              border-radius: 6px;
              font-size: 0.85rem;
              font-weight: 500;
              z-index: 1001;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
              white-space: nowrap;
              opacity: 0;
              visibility: hidden;
              transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
          }
          .global-overlay-message.show {
              opacity: 1;
              visibility: visible;
          }
          .flex-form-group {
              display: flex;
              flex-wrap: wrap;
              justify-content: center;
              gap: 0.25rem;
              margin-bottom: 0.5rem;
          }
          .flex-form-item {
              flex-basis: 110px;
              flex-grow: 0;
              flex-shrink: 0;
              display: flex;
              flex-direction: column;
              align-items: center;
              min-width: 100px;
              max-width: 110px;
          }
          .flex-form-item select {
              width: 70%;
              min-height: 2.8rem;
              padding-top: 0.8rem;
              padding-bottom: 0.8rem;
          }
          /* New Styles for Photo/Secret Code Sections */
          .verification-method-choice {
              display: flex;
              justify-content: center;
              gap: 0.25rem;
              margin-bottom: 1rem;
          }
          .verification-method-choice .btn {
              padding: 0.6rem 1rem;
              border-radius: 0.75rem;
              font-weight: 600;
              cursor: pointer;
              border: 2px solid transparent;
              transition: all 0.2s ease-in-out;
              box-shadow: 0 2px 5px rgba(0,0,0,0.1);
              margin-left: 45px;
              margin-right: 45px;
          }
          .verification-method-choice .btn.active {
              border-color: #6366f1;
              box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
              transform: translateY(-1px);
          }
          .photo-verification-section, .secret-code-verification-section {
              display: none;
              flex-direction: row;
              align-items: flex-start;
              gap: 15px;
              justify-content: center;
              width: 100%;
              padding: 0.75rem 0;
              border-top: 1px solid #e5e7eb;
              margin-top: 0.75rem;
          }
          .photo-verification-section.active, .secret-code-verification-section.active {
              display: flex;
          }
          .video-container {
              width: 100%;
              max-width: 200px;
              margin: 0;
              position: relative;
              background-color: #000;
              border-radius: 0.75rem;
              overflow: hidden;
              aspect-ratio: 1 / 1;
          }
          .video-container video, .video-container canvas {
              display: block;
              width: 100%;
              height: 100%;
              object-fit: cover;
              border: 2px solid #3b82f6;
              border-radius: 0.75rem;
          }
          .video-container canvas {
              position: absolute;
              top: 0;
              left: 0;
              opacity: 0;
              transition: opacity 0.3s ease-in-out;
          }
          .video-container canvas.show {
              opacity: 1;
          }
          .camera-buttons {
              display: flex;
              flex-direction: column;
              justify-content: flex-start;
              align-items: stretch;
              gap: 8px;
              margin-top: 0;
              margin-bottom: 0.1rem;
              flex-wrap: nowrap;
          }
          .camera-buttons .btn {
              min-width: 80px;
              max-width: 130px;
              flex-grow: 0;
              flex-shrink: 0;
              padding: 0.4rem 0.8rem;
              font-size: 0.85rem;
              white-space: nowrap;
              text-align: center;
          }
  
          .secret-code-input-group {
              display: flex;
              align-items: center;
              gap: 8px;
              justify-content: center;
          }
          .secret-code-input-group input[type="password"] {
              width: 120px;
          }
          .secret-code-input-group button {
              padding: 0.4rem 0.8rem;
              font-size: 0.85rem;
          }
          #lane_house_fields label {
                white-space: nowrap;
          }
          #society_name {
        
            width: 150px !important; /* or any width you prefer */
            max-width: none !important; /* to keep it responsive */
            box-sizing: border-box; /* so padding/border don't increase width */
            margin: 0 auto;
          }
          /* Responsive Styles */
          @media (max-width: 798px) {
              body { padding-top: 60px; }
              .ribbon {
                  height: 45px;
                  font-size: 1.4rem;
                  top: 10px;
                  max-width: 95%;
                  width: 95%;
              }
              .ribbon h2 { font-size: 1.4rem; }
              .content-area-wrapper { max-width: 95%; }
              .container {
                  padding: 1rem;
                  margin-top: 10px;
                  margin-bottom: 10px;
                  width: min(400px, 95%);
              }
              .global-overlay-message { bottom: 10px; right: 10px; padding: 6px 10px; font-size: 0.75rem; }
              .verification-method-choice .btn { min-width: 120px; flex-grow: 1; }
              .photo-verification-section {
                  flex-direction: column;
                  align-items: center;
                  gap: 10px;
              }
              .video-container { margin: 0 auto; }
              .camera-buttons {
                  flex-direction: row;
                  flex-wrap: wrap;
                  justify-content: center;
                  width: 100%;
                  margin-top: 0.5rem;
                  margin-bottom: 0.1rem;
              }
              .camera-buttons .btn {
                  min-width: 80px;
                  max-width: 130px;
                  flex-grow: 1;
              }
          }
  
          @media (max-width: 480px) {
              .ribbon { height: 35px; }
              .ribbon h2 { font-size: 1.2rem; }
              .global-overlay-message { bottom: 5px; right: 5px; font-size: 0.7rem; }
              .flex-form-group { flex-direction: column; gap: 0.5rem; width: 100%; margin: 0; }
              .flex-form-item { min-width: unset; width: 100%; flex-basis: auto; }
              .flex-form-item select, .flex-form-item input[type="text"] { width: 100%; } /* Apply to text input too */
              .btn-primary, .btn-secondary, .btn-green { width: 100%; }
              .camera-buttons .btn { width: 100%; min-width: unset; max-width: none; flex-grow: 1; }
              .secret-code-input-group { flex-direction: column; gap: 8px; }
              .secret-code-input-group input[type="password"],
              .secret-code-input-group button { width: 100% !important; margin: 0 auto; }
          }
      </style>
      <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
      <meta http-equiv="Pragma" content="no-cache">
      <meta http-equiv="Expires" content="0">
  </head>
<body>
      <div class="ribbon">
        <h2>
        Validate Vote Details <span class="siva-text"> SIVA </span>
        </h2>
        </div>

    <div class="content-area-wrapper">
        <div class="container">
            <h1 class="text-3xl font-bold text-center text-white mb-4 px-4 py-2 rounded-lg shadow-md" style="color: #04010f; display: inline-block; max-width: 100%; margin: 0 auto;">
                Enter Vote Details
            </h1>
            <div id="message_display_box" class="message-box hidden"></div>
            <form id="voteForm" onsubmit="event.preventDefault();">
              
              <div class="form-group" style="display: none;">
                  <div class="radio-group">
                      <label class="radio-option" id="apartment_option">
                          <input type="radio" name="community_type" value="apartment" id="apartment_type" checked>
                          <span>Apartment</span>
                      </label>
                      <label class="radio-option" id="individual_option">
                          <input type="radio" name="community_type" value="individual" id="individual_type">
                          <span>Individual Homes</span>
                      </label>
                  </div>
              </div>

            <div class="form-group" style="text-align: center;">
                <label for="society_name" style="font-size: 1.1rem; font-weight: 600; display: block; margin-bottom: 0.5rem;">
                    Society Name:
                </label>
                <input
                    type="text"
                    id="society_name"
                    name="society_name"
                    class="text-center"
                    autocomplete="off"
                    autofocus
                    placeholder="SOCIETY NAME"
                    oninput="this.value = this.value.toUpperCase()"
                    style="font-size: 1rem; padding: 0.8rem; text-align: center; width: 250px; display: block; margin: 0 auto;"
                />
            </div> 

            <div style="position: absolute; top: 115px; right: 25px;">
                <div style="display: flex; flex-direction: column; justify-content: space-around;"> 
                    <label style="display: flex; align-items: center; gap: 0.4rem; cursor: pointer; font-weight: 500; margin-bottom: 0.25rem;">
                        <input type="radio" name="app_mode" value="vote" id="mode_vote" checked style="width: 1.1rem; height: 1.1rem; accent-color: #6366f1;">
                        <span style="font-size: 0.9rem;"><b>Voting:</b> To vote</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.4rem; cursor: pointer; font-weight: 500;">
                        <input type="radio" name="app_mode" value="check" id="mode_check" style="width: 1.1rem; height: 1.1rem; accent-color: #6366f1;">
                        <span style="font-size: 0.9rem;"><b>Check:</b> Last voting Time</span>
                    </label>
                </div>
            </div>

            <div style="border-bottom: 1px solid #e5e7eb; margin-bottom: 1rem; margin-top: 1rem;"></div>

            <div id="dynamic_form_fields" class="hidden-fields">
                
                <div id="apartment_field_group" class="flex-form-group hidden-fields">
                    <div class="flex-form-item">
                        <label for="tower">Tower:</label>
                        <select id="tower" name="tower" class="text-center" autocomplete="off">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div class="flex-form-item">
                        <label for="floor">Floor:</label>
                        <select id="floor" name="floor" class="text-center" autocomplete="off">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div class="flex-form-item">
                        <label for="flat_id">Flat:</label>
                        <select id="flat_id" name="flat_id" class="text-center" autocomplete="off">
                            <option value="">Select...</option>
                        </select>
                    </div>
                </div>          
            
                <div id="individual_home_type_fields" class="form-group hidden-fields" style="display: none;">
                    <label>Individual Homes Type:</label>
                    <div class="radio-group">
                        <label class="radio-option" id="with_lanes_option">
                            <input type="radio" name="individual_home_type" value="with_lanes" id="with_lanes">
                            <span>With Lanes</span>
                        </label>
                        <label class="radio-option" id="no_lanes_option">
                            <input type="radio" name="individual_home_type" value="no_lanes" id="no_lanes">
                            <span>No Lanes</span>
                        </label>
                    </div>
                </div>
                
                <div id="lane_house_fields" class="form-group hidden-fields">
                    <div class="flex-form-group">
                        <div class="flex-form-item">
                            <label for="lane">Lane:</label>
                            <select id="lane" name="lane" class="text-center">
                                <option value="">Select...</option>
                            </select>
                        </div>
                        <div class="flex-form-item">
                            <label for="house_number">House Number:</label>
                            <select id="house_number" name="house_number" class="text-center">
                                <option value="">Select...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="no_lane_fields" class="form-group hidden-fields">
                    <div class="flex-form-group">
                        <div class="flex-form-item" style="width: 100%; max-width: 300px;">
                            <label for="flat_no_lanes">Voter / House ID:</label>
                            <select id="flat_no_lanes" name="flat_no_lanes" class="text-center">
                                <option value="">Select...</option>
                            </select>
                        </div>
                    </div>
                </div>
            
                <div class="verification-method-choice">
                    <button type="button" id="photoVerifyBtn" class="btn btn-green">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 inline-block mr-1">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                        </svg>
                        Photo
                    </button>
                    <button type="button" id="secretCodeVerifyBtn" class="btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 inline-block mr-1">
                            <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
                        </svg>
                        Code
                    </button>
                </div>

                <div id="photo_verification_section" class="photo-verification-section">
                    <div class="video-container">
                        <video id="video" autoplay style="display: block;"></video>
                        <canvas id="canvas"></canvas>
                    </div>
                    <div class="camera-buttons">
                        <button type="button" id="startCameraButton" class="btn btn-green">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 inline-block mr-1">
                                <path d="M16.72 8.44l-2.67-2.68a1.5 1.5 0 00-2.12 0l-.35.35A.75.75 0 0110.25 5h-.5a.75.75 0 01-.53-.29l-.35-.35a1.5 1.5 0 00-2.12 0L3.28 8.44a.75.75 0 00-.02 1.06l.87.88a.75.75 0 001.06 0l.47-.47a.75.75 0 01.53-.22h2.08a.75.75 0 01.53.22l.47.47a.75.75 0 001.06 0l.88-.88a.75.75 0 00-.02-1.06zM3.75 12h-.5a.75.75 0 00-.75.75v3.5c0 .414.336.75.75.75h13.5a.75.75 0 00.75-.75v-3.5a.75.75 0 00-.75-.75h-.5a.75.75 0 01-.75-.75V9.75a.75.75 0 00-.75-.75h-2.5a.75.75 0 00-.75.75v1.5c0 .414.336.75.75.75h-2.5a.75.75 0 01-.75-.75v-1.5a.75.75 0 00-.75-.75h-2.5a.75.75 0 00-.75.75v1.5c0 .414.336.75.75.75z" />
                            </svg>
                            Start Cam
                        </button>
                        <button type="button" id="verifyPhotoButton" class="btn btn-primary" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 inline-block mr-1">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                            Verify Face
                        </button>
                        <button type="button" id="stopCameraButton" class="btn btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 inline-block mr-1">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                            Stop Cam
                        </button>
                    </div>
                </div>

                <div id="secret_code_verification_section" class="secret-code-verification-section">
                    <div class="secret-code-input-group">
                        <label for="secret_code" style="white-space: nowrap;">
                            Enter Code:
                        </label>
                        <input type="password" id="secret_code" name="secret_code" class="border px-2 py-1" style="width: 150px; height: 36px;">
                        <button type="button" id="submitSecretCodeButton" class="btn-primary" style="height: 36px;" disabled>
                            Submit
                        </button>
                    </div>
                </div>

              </div> <div id="alreadyVotedMessageSection" style="display:none; text-align:center; padding: 20px; background-color: #fee2e2; color: #991b1b; border-radius: 0.5rem; margin-top: 15px;">
                  <h3 class="text-xl font-semibold">You have already voted.</h3>
                  <p class="mt-2">Thank you for your participation.</p>
                  <p class="mt-2"><strong>Your ID: <span id="votedIdDisplay"></span></strong></p>
                  <div class="mt-4">
                      <a href="#" class="btn-primary mt-4 bg-gray-500 hover:bg-gray-600">
                          Go back to Homepage
                      </a>
                  </div>
              </div>    
            </form>
          
            <div class="back-container" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">
                  <a href="{{ url_for('select_language') }}" class="btn-primary mt-4 bg-gray-500 hover:bg-gray-600">
                      Back to Language Selection
                  </a>
            </div>     
            
        </div>
    </div>

    <div id="flash-messages">
        <div class="flash-message success" style="display: none;">
            Your vote has been recorded successfully.
        </div>
    </div>

    <div class="global-overlay-message" id="global-overlay-message"></div>
 
<script>
    // --- Data is now fetched dynamically ---
    let dynamicCommunityData = {};
    let currentCommunityType = null; // e.g., 'apartment', 'individual_lanes', 'individual_no_lanes'

    // --- Variable declarations ---
    const societyInput = document.getElementById('society_name');
    const dynamicFormFields = document.getElementById('dynamic_form_fields');
    const apartmentFieldGroup = document.getElementById('apartment_field_group');
    const laneHouseFields = document.getElementById('lane_house_fields');
    
    const towerSelect = document.getElementById('tower');
    const floorSelect = document.getElementById('floor');
    const flatIdSelect = document.getElementById('flat_id');
    const laneSelect = document.getElementById('lane');
    const houseNumberSelect = document.getElementById('house_number');
    const flatNoLanesSelect = document.getElementById('flat_no_lanes');
    const photoVerifyBtn = document.getElementById('photoVerifyBtn');
    const secretCodeVerifyBtn = document.getElementById('secretCodeVerifyBtn');
    const photoSection = document.getElementById('photo_verification_section');
    const secretCodeSection = document.getElementById('secret_code_verification_section');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const startCameraButton = document.getElementById('startCameraButton');
    const verifyPhotoButton = document.getElementById('verifyPhotoButton');
    const stopCameraButton = document.getElementById('stopCameraButton');
    const secretCodeInput = document.getElementById('secret_code');
    const submitSecretCodeButton = document.getElementById('submitSecretCodeButton');
    const messageDisplayBox = document.getElementById('message_display_box');
    const globalOverlayMessage = document.getElementById('global-overlay-message');

    let currentStream = null;
    let isVerified = false;
    let currentVerificationMethod = null;
 
    function resetDynamicFields() { 
        dynamicFormFields.classList.add('hidden-fields');
        apartmentFieldGroup.classList.add('hidden-fields');
        laneHouseFields.classList.add('hidden-fields');
        document.getElementById('no_lane_fields').classList.add('hidden-fields');

        towerSelect.innerHTML = '<option value="">Select...</option>';
        floorSelect.innerHTML = '<option value="">Select...</option>';
        flatIdSelect.innerHTML = '<option value="">Select...</option>';
        laneSelect.innerHTML = '<option value="">Select...</option>';
        houseNumberSelect.innerHTML = '<option value="">Select...</option>';
        flatNoLanesSelect.innerHTML = '<option value="">Select...</option>';

        towerSelect.disabled = false;
        floorSelect.disabled = true;
        flatIdSelect.disabled = true;
        laneSelect.disabled = false;
        houseNumberSelect.disabled = true;

        dynamicCommunityData = {};
        currentCommunityType = null;
        
        switchVerificationMethod(null); // Hide verification sections
        
        // --- FIX: Disable method buttons ---
        photoVerifyBtn.disabled = true;
        secretCodeVerifyBtn.disabled = true;
        // ---------------------------------
        
        validateFormAndEnableVerify(); // Disable submit buttons
    }

    /**
     * Fetches society details from the backend and populates the UI.
     */
    async function fetchSocietyDetails() {
        const societyName = societyInput.value.trim();
        if (!societyName) {
            resetDynamicFields();
            return;
        }

        showGlobalOverlay("Fetching society details...");
        
        try {
            const response = await fetch('/api/get_society_details', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ society: societyName })
            });

            const data = await response.json();

            // --- THIS IS THE CORRECT LOGIC FOR THIS FUNCTION ---
            if (data.success) {
                hideGlobalOverlay();
                dynamicCommunityData = data.community_data;
                currentCommunityType = data.community_type;
                
                // --- FIX: Enable method buttons ---
                photoVerifyBtn.disabled = false;
                secretCodeVerifyBtn.disabled = false;
                // ----------------------------------
                
                populateDynamicFields();
                document.getElementById('dynamic_form_fields').classList.remove('hidden-fields');
            } else {
                hideGlobalOverlay();
                alert(data.message);
                resetDynamicFields();
            }
            // --- END OF CORRECT LOGIC ---

        } catch (err) {
            console.error("Error fetching society details:", err);
            hideGlobalOverlay();
            alert("An error occurred while fetching society details.");
            resetDynamicFields();
        }
    }

    /**
     * Shows the correct dropdowns based on the fetched community type.
     */
    function populateDynamicFields() {
        // Hide all dynamic groups first
        apartmentFieldGroup.classList.add('hidden-fields');
        laneHouseFields.classList.add('hidden-fields');
        document.getElementById('no_lane_fields').classList.add('hidden-fields');

        // Use trim() to be safe
        const cleanType = currentCommunityType ? currentCommunityType.trim() : '';

        if (cleanType === 'apartment') {
            apartmentFieldGroup.classList.remove('hidden-fields');
            populateApartmentDropdowns();
        } else if (cleanType === 'individual_lanes') {
            laneHouseFields.classList.remove('hidden-fields');
            populateLaneDropdowns();
        } else if (cleanType === 'individual_no_lanes') {
            document.getElementById('no_lane_fields').classList.remove('hidden-fields');
            flatNoLanesSelect.innerHTML = '<option value="">Select...</option>';
            if (dynamicCommunityData && dynamicCommunityData.flats) {
                for (const flat of dynamicCommunityData.flats) {
                    flatNoLanesSelect.innerHTML += `<option value="${flat}">${flat}</option>`;
                }
            }
            flatNoLanesSelect.disabled = false;
        }
        
        validateFormAndEnableVerify();
    }

    /**
     * Populates the Tower dropdown for apartments.
     */
    function populateApartmentDropdowns() {
        towerSelect.innerHTML = '<option value="">Select...</option>';
        floorSelect.innerHTML = '<option value="">Select...</option>';
        flatIdSelect.innerHTML = '<option value="">Select...</option>';
        floorSelect.disabled = true;
        flatIdSelect.disabled = true;

        if (!dynamicCommunityData || Object.keys(dynamicCommunityData).length === 0) {
            console.error("No apartment data found for this society.");
            return;
        }

        const towers = Object.keys(dynamicCommunityData).sort();
        for (const tower of towers) {
            towerSelect.innerHTML += `<option value="${tower}">${tower}</option>`;
        }

        if (towers.length === 1) {
            towerSelect.value = towers[0];
            towerSelect.disabled = true;
            towerSelect.dispatchEvent(new Event('change'));
        } else {
            towerSelect.disabled = false;
        }
    }

    /**
     * Populates the Lane dropdown for individual homes with lanes.
     */
    function populateLaneDropdowns() {
        laneSelect.innerHTML = '<option value="">Select...</option>';
        houseNumberSelect.innerHTML = '<option value="">Select...</option>';
        houseNumberSelect.disabled = true;

        if (!dynamicCommunityData || Object.keys(dynamicCommunityData).length === 0) {
            console.error("No lane data found for this society.");
            return;
        }

        const lanes = Object.keys(dynamicCommunityData).sort();
        for (const lane of lanes) {
            laneSelect.innerHTML += `<option value="${lane}">${lane}</option>`;
        }
        laneSelect.disabled = false;
    }


    function getUserId() {
        let id = '';
        const society = societyInput.value.trim();
        
        if (currentCommunityType === 'apartment') {
            if (towerSelect.value && floorSelect.value && flatIdSelect.value) {
                id = `${society}-${towerSelect.value}-${floorSelect.value}-${flatIdSelect.value}`;
            }
        } else if (currentCommunityType === 'individual_lanes') {
            if (laneSelect.value && houseNumberSelect.value) {
                id = `${society}-${laneSelect.value}-${houseNumberSelect.value}`;
            }
        } else if (currentCommunityType === 'individual_no_lanes') {
             if (flatNoLanesSelect.value) { // Check if a value is selected
                id = `${society}-${flatNoLanesSelect.value}`;
            }
        }
        return id;
    }

    /**
     * Checks if all required fields for the current community type are selected.
     */
    function areDetailsSelected() {
        const society = societyInput.value.trim();
        if (!society) return false;

        if (currentCommunityType === 'apartment') {
            return towerSelect.value && floorSelect.value && flatIdSelect.value && society;
        } else if (currentCommunityType === 'individual_lanes') {
            return laneSelect.value && houseNumberSelect.value && society;
        } else if (currentCommunityType === 'individual_no_lanes') {
            return flatNoLanesSelect.value && society;
        }
        return false; // Default
    }

    function displayMessage(type, message, duration = 4000) {
        messageDisplayBox.className = `message-box message-${type} show`;
        messageDisplayBox.innerHTML = message;
        if (messageDisplayBox.timeout) {
            clearTimeout(messageDisplayBox.timeout);
        }
        messageDisplayBox.timeout = setTimeout(() => {
            messageDisplayBox.classList.remove('show');
            setTimeout(() => {
                messageDisplayBox.className = 'message-box hidden';
            }, 300);
        }, duration);
    }

    function showGlobalOverlay(message, isError = false) {
        globalOverlayMessage.textContent = message;
        globalOverlayMessage.className = 'global-overlay-message show';
        globalOverlayMessage.style.backgroundColor = isError ? 'rgba(220, 38, 38, 0.7)' : 'rgba(0, 0, 0, 0.6)';
    }

    function hideGlobalOverlay() {
        globalOverlayMessage.classList.remove('show');
    }

    /**
     * Enables/disables verification buttons based on form completion.
     */
    function validateFormAndEnableVerify() {
        const idSelected = areDetailsSelected();
        
        if (currentVerificationMethod === 'photo') {
            verifyPhotoButton.disabled = !idSelected || currentStream === null;
            submitSecretCodeButton.disabled = true;
        } else if (currentVerificationMethod === 'secret_code') {
            submitSecretCodeButton.disabled = !idSelected || secretCodeInput.value.trim().length === 0;
            verifyPhotoButton.disabled = true;
        } else {
            // No method selected
            verifyPhotoButton.disabled = true;
            submitSecretCodeButton.disabled = true;
        }
    }

    function switchVerificationMethod(method) {
        currentVerificationMethod = method;

        photoVerifyBtn.classList.remove('active', 'btn-green');
        photoVerifyBtn.classList.add('btn-secondary');
        secretCodeVerifyBtn.classList.remove('active', 'btn-green');
        secretCodeVerifyBtn.classList.add('btn-secondary');

        photoSection.classList.remove('active');
        secretCodeSection.classList.remove('active');
        
        if (!method) { // Call to hide sections
             stopCamera();
             validateFormAndEnableVerify();
             return;
        }

        if (method === 'photo') {
            photoVerifyBtn.classList.add('active', 'btn-green');
            photoVerifyBtn.classList.remove('btn-secondary');
            photoSection.classList.add('active');
            stopCamera(); // Ensure camera is off before starting
        } else if (method === 'secret_code') {
            secretCodeVerifyBtn.classList.add('active', 'btn-green');
            secretCodeVerifyBtn.classList.remove('btn-secondary');
            secretCodeSection.classList.add('active');
            stopCamera();
        }

        validateFormAndEnableVerify();
    }

    async function startCamera() {
        if (currentStream) return;
        try {
            showGlobalOverlay("Starting camera...");
            const constraints = { video: { facingMode: "user" } };
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = currentStream;
            await video.play();
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            hideGlobalOverlay();
            startCameraButton.disabled = true;
            stopCameraButton.disabled = false;
            validateFormAndEnableVerify();
        } catch (err) {
            console.error("Error accessing camera:", err);
            hideGlobalOverlay();
            alert('Could not access camera. Please check browser permissions.');
            startCameraButton.disabled = false;
            stopCameraButton.disabled = true;
            validateFormAndEnableVerify();
        }
    }

    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
            video.srcObject = null;
        }
        startCameraButton.disabled = false;
        stopCameraButton.disabled = true;
        canvas.classList.remove('show');
        validateFormAndEnableVerify();
    }

    function captureFrame() {
        if (!currentStream) return null;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.classList.add('show');
        return canvas.toDataURL('image/jpeg', 0.9);
    }

    async function verifyPhoto() {
        if (isVerified) return;
        if (!areDetailsSelected()) {
            alert('Please select all details first (Society, Tower, Floor, etc.).');
            return;
        }
        const photoDataUrl = captureFrame();
        if (!photoDataUrl) {
            alert('No photo captured. Please start the camera first.');
            return;
        }

        showGlobalOverlay("Verifying face...");
        verifyPhotoButton.disabled = true;

        // Build dynamic payload
        let payload = {
            society: societyInput.value.trim(),
            image_data: photoDataUrl,
            mode: document.getElementById('mode_check').checked ? 'check' : 'vote'
        };
        if (currentCommunityType === 'apartment') {
            payload.tower = towerSelect.value;
            payload.flat = flatIdSelect.value;
        } else if (currentCommunityType === 'individual_lanes') {
            payload.lane = laneSelect.value;
            payload.house = houseNumberSelect.value;
        } else if (currentCommunityType === 'individual_no_lanes') { // <-- FIX ADDED
            payload.flat = flatNoLanesSelect.value;
        }

        try {
            const response = await fetch('/api/verify_face', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            // --- THIS IS THE NEW, CORRECT LOGIC ---
            if (data.success) {
                isVerified = true;
                stopCamera();
                hideGlobalOverlay();
                
                const isCheckMode = document.getElementById('mode_check').checked;
                const timestamp = data.voted_at; 

                if (isCheckMode) {
                    if (timestamp) {
                        const proofMessage = `
                            Vote Record Found:
                            --------------------
                            Last Voted On: ${timestamp}
                        `;
                        alert(proofMessage);
                    } else {
                        alert("No voting record found.");
                    }
                } else {
                    // User wants to VOTE
                    if (timestamp) {
                        alert("You have already voted.");
                    } else {
                        showGlobalOverlay("Verification Successful. Loading ballot...");
                        setTimeout(() => { 
                            window.location.replace(data.redirect_url); 
                        }, 1500);
                    }
                }
            } else {
                hideGlobalOverlay();
                alert(data.message || "Verification failed.");
            }
            // --- END OF NEW LOGIC ---

        } catch (error) {
            hideGlobalOverlay();
            console.error('Photo verification error:', error);
            alert('An error occurred during photo verification.');
        } finally {
            if (!isVerified) verifyPhotoButton.disabled = false;
        }
    }
 
    document.addEventListener('DOMContentLoaded', () => {
    
        // âœ… CRITICAL FIX: Forces a fresh page load when user navigates back (BFcache prevention).
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                location.reload(); 
            }
        });

        // --- FIX: Disable method buttons on load ---
        photoVerifyBtn.disabled = true;
        secretCodeVerifyBtn.disabled = true;
        // -----------------------------------------

        // --- Listen for society input blur ---
        societyInput.addEventListener('blur', fetchSocietyDetails);
        societyInput.addEventListener('keyup', (event) => { 
            if (event.key === 'Enter') {
                societyInput.blur();
            }
        });


        // --- DYNAMIC DROPDOWN LISTENERS ---

        towerSelect.addEventListener('change', () => {
            floorSelect.innerHTML = '<option value="">Select...</option>';
            flatIdSelect.innerHTML = '<option value="">Select...</option>';
            flatIdSelect.disabled = true;
            const selectedTower = towerSelect.value;
            if (selectedTower && dynamicCommunityData[selectedTower]) {
                for (const floor of Object.keys(dynamicCommunityData[selectedTower]).sort()) {
                    floorSelect.innerHTML += `<option value="${floor}">${floor}</option>`;
                }
                floorSelect.disabled = false;
            }
            validateFormAndEnableVerify();
        });

        floorSelect.addEventListener('change', () => {
            flatIdSelect.innerHTML = '<option value="">Select...</option>';
            const selectedTower = towerSelect.value;
            const selectedFloor = floorSelect.value;
            if (selectedFloor && dynamicCommunityData[selectedTower] && dynamicCommunityData[selectedTower][selectedFloor]) {
                for (const flat of dynamicCommunityData[selectedTower][selectedFloor]) {
                    flatIdSelect.innerHTML += `<option value="${flat}">${flat}</option>`;
                }
                flatIdSelect.disabled = false;
            }
            validateFormAndEnableVerify();
        });
        
        laneSelect.addEventListener('change', () => {
            houseNumberSelect.innerHTML = '<option value="">Select...</option>';
            const selectedLane = laneSelect.value;
            if (selectedLane && dynamicCommunityData[selectedLane]) {
                 for (const house of dynamicCommunityData[selectedLane].sort()) {
                    houseNumberSelect.innerHTML += `<option value="${house}">${house}</option>`;
                }
                houseNumberSelect.disabled = false;
            }
            validateFormAndEnableVerify();
        });

        flatIdSelect.addEventListener('change', validateFormAndEnableVerify);
        houseNumberSelect.addEventListener('change', validateFormAndEnableVerify);
        flatNoLanesSelect.addEventListener('change', validateFormAndEnableVerify);

        // --- VERIFICATION BUTTON LISTENERS ---

        submitSecretCodeButton.addEventListener('click', async () => {
            if (!areDetailsSelected() || !secretCodeInput.value) {
                alert('Error: All fields are required.');
                return;
            }

            let payload = {
                society: societyInput.value.trim(),
                secret_code: secretCodeInput.value,
                mode: document.getElementById('mode_check').checked ? 'check' : 'vote'
            };
 
            if (currentCommunityType === 'apartment') {
                let flatValue = flatIdSelect.value;
                if (flatValue.length === 3) flatValue = "0" + flatValue;
                payload.tower = towerSelect.value;
                payload.flat = flatValue;
            } else if (currentCommunityType === 'individual_lanes') {
                payload.lane = laneSelect.value;
                payload.house = houseNumberSelect.value;
            } else if (currentCommunityType === 'individual_no_lanes') {
                payload.flat = flatNoLanesSelect.value;
            }

            showGlobalOverlay("Verifying...");
            try {
                const response = await fetch('/api/verify_code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json(); 

                // --- THIS IS THE NEW, CORRECT LOGIC ---
                if (data.success) {
                    hideGlobalOverlay();
                    
                    const isCheckMode = document.getElementById('mode_check').checked;
                    const timestamp = data.voted_at; 

                    if (isCheckMode) {
                        if (timestamp) {
                            const proofMessage = `
                                Vote Record Found:
                                --------------------
                                Last Voted On: ${timestamp}
                            `;
                            alert(proofMessage);
                        } else {
                            alert("No voting record found.");
                        }
                    } else {
                        // User wants to VOTE
                        if (timestamp) {
                            alert("You have already voted.");
                        } else {
                            showGlobalOverlay("Verification Successful. Loading ballot...");
                            setTimeout(() => { 
                                window.location.replace(data.redirect_url); 
                            }, 1500);
                        }
                    }
                } else {
                    hideGlobalOverlay();
                    alert(data.message);
                }
                // --- END OF NEW LOGIC ---

            } catch (err) {
                console.error("Secret code verification error:", err);
                hideGlobalOverlay();
                alert('A server error occurred during verification.');
            }
        });

        photoVerifyBtn.addEventListener('click', () => {
            if (areDetailsSelected()) { switchVerificationMethod('photo'); } 
            else { alert('Please enter society and select all details first.'); }
        });
        secretCodeVerifyBtn.addEventListener('click', () => {
            if (areDetailsSelected()) { switchVerificationMethod('secret_code'); } 
            else { alert('Please enter society and select all details first.'); }
        });

        secretCodeInput.addEventListener('input', validateFormAndEnableVerify);

        startCameraButton.addEventListener('click', startCamera);
        stopCameraButton.addEventListener('click', stopCamera);
        verifyPhotoButton.addEventListener('click', verifyPhoto);
    }); 

    // Prevent back-button caching issues
    window.onload = function () {
        history.pushState(null, null, location.href);
        window.addEventListener('popstate', function(event) {
            history.pushState(null, null, location.href);
        });
        const navEntry = performance.getEntriesByType("navigation")[0];
        const isBackNav = performance.navigation.type === 2 || (navEntry && navEntry.type === "back_forward");
        if (isBackNav) { location.reload(); }
    };
     
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
        if (
        e.key === "F12" ||
        (e.ctrlKey && e.shiftKey && ["I", "J", "C"].includes(e.key.toUpperCase())) ||
        (e.ctrlKey && e.key.toUpperCase() === "U")
        ) e.preventDefault();
    }); 

</script>
  <footer class="fixed bottom-2 left-1/2 transform -translate-x-1/2 text-lg text-gray-500 select-none pointer-events-auto z-50">
    D3 by: 
    <a href="mailto:siva.admn25@gmail.com" style="color: #0000FF;" class="underline hover:text-blue-700">
      siva.admn25@gmail.com
    </a>
  </footer>
</body>
</html> 